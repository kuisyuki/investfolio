# 要件定義書

## 概要

個人の株式資産と配当を管理するWebサービスです。学習目的で開発され、Ubuntuの開発コンテナ環境でローカル実行されます。フロントエンドはTypeScript + Next.js、バックエンドはPython + FastAPIで構築し、外部APIから株価データを取得して資産推移を可視化します。

## 機能要件

### 要件1: 株式資産管理機能

**ユーザーストーリー:** 投資家として、自分の株式保有状況を管理したいので、銘柄の登録・編集・削除機能が必要です。

#### 受入基準

1. 新しい銘柄を追加する時、銘柄コード、銘柄名、保有株数、取得価格が登録されること
2. 保有銘柄を表示する時、現在の株価と評価損益が表示されること
3. 保有銘柄を編集する時、保有株数と取得価格が更新できること
4. 保有銘柄を削除する時、確認ダイアログ後に削除されること
5. 株価データを取得する時、APIキー不要の外部APIから最新株価が取得されること
6. システムログイン時、保有株の最新価格が自動取得されてDBに保存されること
7. 株価更新ボタンを押した時、保有株の最新価格が取得されてDBに保存されること

### 要件2: 配当管理機能

**ユーザーストーリー:** 投資家として、受け取った配当を記録・管理したいので、配当履歴の登録・表示機能が必要です。

#### 受入基準

1. 配当を受け取る時、銘柄、配当金額、受取日が登録されること
2. 配当履歴を表示する時、銘柄別・期間別の配当一覧が表示されること
3. 配当統計を確認する時、月別・年別の配当合計が表示されること
4. 配当利回りを計算する時、現在の保有株数と株価から配当利回りが算出されること

### 要件3: データ可視化機能

**ユーザーストーリー:** 投資家として、資産の推移を視覚的に把握したいので、グラフやチャートでの可視化機能が必要です。

#### 受入基準

1. 資産推移を確認する時、Kibanaで時系列グラフが表示されること
2. ポートフォリオを分析する時、銘柄別の資産構成比が円グラフで表示されること
3. 配当推移を確認する時、月別・年別の配当推移グラフが表示されること
4. 損益を分析する時、実現損益と含み損益が分けて表示されること

### 要件4: 外部連携・公開機能

**ユーザーストーリー:** 開発者として、開発中のアプリケーションを他者に共有したいので、一時的な外部公開機能が必要です。

#### 受入基準

1. 外部公開する時、Ngrokを使用して一時的なURLが生成されること
2. 株価データを取得する時、APIキー不要の外部株価APIが使用されること
3. データを更新する時、定期的に最新の株価データが取得されること
4. 外部からアクセスする時、適切なCORS設定が行われていること

### 要件5: セキュリティ・データ保護

**ユーザーストーリー:** ユーザーとして、個人の資産情報を安全に管理したいので、適切なセキュリティ対策が必要です。

#### 受入基準

1. データを保存する時、機密情報が適切に暗号化されること
2. APIにアクセスする時、適切な認証・認可が行われること
3. データベースにアクセスする時、SQLインジェクション対策が実装されること
4. ログを記録する時、個人情報がマスキングされること

## 非機能要件（開発環境要件）

### 要件6: 開発環境構築

**ユーザーストーリー:** 開発者として、一貫した開発環境でアプリケーションを構築したいので、Dockerコンテナベースの開発環境が必要です。

#### 受入基準

1. 開発コンテナを起動する時、devcontainerでUbuntu OSベースのコンテナが起動されること
2. コンテナがリビルドされる時、PostCreateCommand.shが自動実行されること  
3. Dockerfileが作成される時、他プロジェクトでも流用可能な汎用的な内容が含まれること
4. Create Commandが実行される時、プロジェクト固有のPython環境設定が行われること
5. 開発コンテナを起動する時、PostStartCommand.shが実行されてバックエンド、フロントエンドが自動起動されること
6. Node.jsのパッケージ管理にpnpmが使用されること
7. Node.jsのバージョン管理にVoltaが使用されること
8. AI駆動開発のためGEMINI CLIが開発コンテナに標準インストールされること
9. VS CodeのCopilot効率化のためMCPとしてSerenaの索引が活用されること
10. コードを保存する時、Black、isort、Ruffが自動実行されること

### 要件7: アプリケーションアーキテクチャ

**ユーザーストーリー:** 開発者として、スケーラブルなWebアプリケーションを構築したいので、適切な技術スタックとアーキテクチャが必要です。

#### 受入基準

1. フロントエンドを開発する時、TypeScript + Next.jsが使用されること
2. バックエンドを開発する時、Python + FastAPIが使用されること
3. アプリケーションを起動する時、uvicornでFastAPIサーバーが動作すること
4. データを保存する時、MySQLデータベースが使用されること
5. Webサーバーを構築する時、Nginxがリバースプロキシとして動作すること
6. MySQL、Kibana、Elasticsearch、Filebeatがdocker-compose.ymlで管理されること
7. TypeScriptコードを書く時、厳密な型チェックが有効になっていること
8. データベースアクセスにSQLAlchemy 2.0+が使用されること
9. データベースマイグレーションにGo製のsql-migrateが使用されること

### 要件8: ログ収集・監視機能

**ユーザーストーリー:** 開発者として、アプリケーションの動作状況を監視したいので、ログ収集・分析機能が必要です。

#### 受入基準

1. ユーザーが操作する時、操作ログがFilebeatで収集されること
2. ログが生成される時、Elasticsearchにログデータが送信されること
3. ログを分析する時、Kibanaでログの検索・可視化ができること
4. エラーが発生する時、エラーログが適切に記録されること